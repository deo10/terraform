pages 211-218

https://kodekloud.com/topic/playground-terraform-aws/

# Даже хороший план может оказаться неудачным
1. Если вы уже начали работать с Terraform, не используйте ничего другого. Если часть вашей инфраструктуры управляется с помощью Terraform, больше нельзя изменять ее вручную. В противном случае вы не только рискуете получить странные ошибки Terraform, но также сводите на нет многие преимущества IaC, так как код больше не будет точным представлением вашей инфраструктуры.
2. Если у вас уже есть какая-то инфраструктура, используйте команду import. Если вы начинаете использовать Terraform с уже существующей инфраструктурой, ее можно добавить в файл состояния с помощью команды terraform import. Так Terraform будет знать, какой инфраструктурой нужно управлять. Команда import принимает два аргумента. Первым служит «адрес» ресурса в ваших конфигурационных файлах. Здесь тот же синтаксис, что и в ссылках на ресурсы: <PROVIDER>_<TYPE>.<NAME> (вроде aws_iam_user.existing_user). Второй аргумент — это идентификатор ресурса, который нужно импортировать. Скажем, в качестве ID ресурса aws_iam_user выступает имя пользователя (например, yevgeniy.brikman), а ID ресурса aws_instance будет идентификатор сервера EC2 (вроде i-190e22e5). То, как импортировать ресурс, обычно указывается в документации внизу его страницы.

пример импорта aws_iam_user
terraform import aws_iam_user.existing_user yevgeniy.brikman

Следует отметить, что, если у вас уже есть много ресурсов, которые вы хотите импортировать в Terraform, ручное написание кода и импорт каждого из них по очереди может оказаться хлопотным занятием. Поэтому стоит обратить внимание на такие инструменты,
terraformer (https://github.com/GoogleCloudPlatform/terraformer)
terracognita (https://github.com/cycloidio/terracognita)
способные автоматически импортировать код и состояние из облачных окружений.


# Рефакторинг может иметь свои подвохи
Вот четыре основных урока, которые вы должны извлечь из этого обсуждения.
1. Всегда используйте команду plan. Она может помочь выявить все эти загвоздки. Тщательно просматривайте ее вывод и обращайте внимание на ситуации, когда Terraform планирует удалить ресурсы, которые, скорее всего, удалять не стоит.
2. Создавайте, прежде чем удалять. Если вы хотите заменить ресурс, хорошенько подумайте, нужно ли создавать замену до удаления оригинала. Если ответ положительный, в этом может помочь create_before_destroy. Того же результата можно добиться вручную, выполнив два шага: сначала добавить в конфигурацию новый ресурс и запустить команду apply, а затем удалить из конфигурации старый ресурс и выполнить apply еще раз.
3. Рефакторинг может повлечь изменение состояния. Если вы решили реорганизовать свой код, не вызвав случайных перебоев, то вам необходимо соответствующим образом обновить состояние Terraform. Однако никогда не следует обновлять файлы состояния Terraform вручную! В таких случаях у вас есть на выбор два варианта: выполнить команду terraform state mv или обеспечить автоматическое обновление состояния, добавив в код блок moved.
4. Некоторые параметры нельзя изменять. Параметры многих ресурсов неизменяемые. Если попытаться их изменить, Terraform удалит старый ресурс и создаст новый. На странице каждого ресурса обычно указывается, что происходит при изменении того или иного параметра, поэтому не забывайте сверяться с документацией. Всегда используйте команду plan и рассматривайте целесообразность применения стратегии create_before_destroy.



